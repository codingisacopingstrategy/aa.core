{% extends "aacore/base.html" %}

{% block extrahead %}
    <style type="text/css" media="screen">
        p.handle {
            margin: 0;
            cursor: move;
            border-bottom: 1px solid black;
            background-color: white;
        }
        p.handle:hover {
            background-color: black;
            color: white;
        }
        .important {
            color: red;
        }
        pre {
            white-space: pre-line;
            font-size: smaller;
        }
        form.source {
            display: none;
        }
        textarea {
            width: 100%;
            height: 200px;
        }
        section {
            border-top: 1px dotted black;
            border-bottom: 1px dotted black;
            background-color: white;
        }
        section + section {
            border-top: 0px dotted black;
        }
        section.annotation:hover {
            z-index: 1002;
        }
        section.annotation {
            border: 1px solid black;
            position: absolute !important;
            width: 300px;
            height: 400px;
            top: 0;
            left: 0;
            font-size: 13px;
            line-height: 17px;
            overflow: hidden;
            box-shadow: 3px 3px 6px #CCC;
        }
        article.rendered {
            width: 100%;
            height: 100%;
            overflow: auto;
            box-sizing: content-box;
            -moz-box-sizing: content-box;
            -ms-box-sizing: content-box;
            -webkit-box-sizing: content-box;
        }
        article.rendered div {
            padding: 10px;
        }
        h1 { 
            text-decoration: underline;
        }
    </style>    
    <script>
        $(document).ready(function() {
            
            {% if geometry %}
            var geometry = {{ geometry|safe }};
            for (i in geometry) {
                $(i).parents("section").width(geometry[i]['width'])
                    .height(geometry[i]['height'])
                    .css('top', geometry[i]['top'] + "px")
                    .css('left', geometry[i]['left'] + "px");
            }
            {% endif %}

            //$("section").addClass('ui-widget-content').draggable({ grid: [ 50,50 ] }).resizable({grid: 50});
            $("section.annotation").draggable({
                'handle':'p.handle',
                'grid': [50, 50],
                'zIndex': 2700,
                'stop': function(event, ui) {
                    var target = $(event.target);
                    $.post("edit/geometry/", {
                            id: "#" + target.find('h1').attr('id'),
                            width: target.width(),
                            height: target.height(),
                            top: ui.position.top,
                            left: ui.position.left,
                        }, function(data) {
                            console.log(data);
                    });
                },
            }).resizable({
                grid: 50,
                'stop': function(event, ui) {
                    var target = $(event.target);
                    $.post("edit/geometry/", {
                            id: "#" + target.find('h1').attr('id'),
                            width: target.width(),
                            height: target.height(),
                            top: ui.position.top,
                            left: ui.position.left,
                        }, function(data) {
                            console.log(data);
                    });
                },
            });

            $("a.edit").click(function() {
                $(this).parents("section").find("form.source").show();
                $(this).parents("section").find("article.rendered").hide();
            });

            $("button.cancel").click(function() {
                var $this = $(this);
                $this.parents("section").find("form.source").hide()
                $this.parents("section").find("article.rendered").show();
            });

            $("button.save").click(function(e) {
                e.preventDefault();

                var $this = $(this);
                var content = $this.parents("section").find("textarea").val();

                var post_url = $this.parents("section").attr("data-post-url");
                $.post(post_url, 
                    {
                        'content': content,
                        'page': "{{ page }}",
                    }, function(data) {
                        console.log($this.parents("div.section"));
                        $this.parents("section").find("form.source").hide()
                        $this.parents("section").find("article.rendered").show();

                });
            });
        });
    </script>


{% endblock %}
{% block body %}
<nav>
    <ul>
        {% if page %}
        <li><a href="{% url aa-page-edit slug=page.name %}">edit</a></li>
        <li><a href="">view history</a></li>
        {% endif %}
    </ul>
</nav>
<article>
    {{ content|safe }}
</article>

{% endblock %}
