import os.path
from fabric.api import run, local, put, cd, sudo, env
 
 
def deploy(treeish='HEAD'):
    env.user = 'sarma'
 
    # makes a tarball of the django project and transfers it
    local('git archive %s . | gzip > project.tar.gz' % treeish)
    put('project.tar.gz', '/home/sarma/www/fr.stdin.oralsite2/')
    local('rm project.tar.gz')
 
    # backups old versions
    with cd('/home/sarma/www/fr.stdin.oralsite2/'):
        import time
        timestamp = time.strftime('%Y%m%d%H%M%S')
        try:
            run('mv aa.core aa.core.%s.bak' % timestamp)
        except:
            pass
        run('mkdir aa.core')
    
    # gunzips the new django project
    with cd('/home/sarma/www/fr.stdin.oralsite2/aa.core/'):
        run('tar zxvf ../project.tar.gz')
        run('rm ../project.tar.gz')
        # put back the database
        run('cp ../aa.core.%s.bak/run/aa.db' % timestamp)
        # make alias media
        #run('ln -s /root/src/Django-1.2.1/django/contrib/admin/media/')
 
 
    # fixes permission issues
    env.user = 'sarma'
    sudo('chown -R sarma:www-data /home/sarma/www/fr.stdin.oralsite2/sarma')
    sudo('chmod -R g+w /home/sarma/www/fr.stdin.oralsite2/sarma')
